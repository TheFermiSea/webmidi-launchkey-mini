<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <style>
      .nlk-half-key {
        display: inline-block;
        width: 12px;
        margin: 1px;
      }
      .nlk-key {
        text-align: center;
        width: 24px;
        border: 0 none;
        margin: 1px;
      }
      .nlk-white {
        background-color: #eee;
        color: #111;
      }
      .nlk-black {
        background-color: #111;
        color: #eee;
      }
    </style>
  </head>
  <body>
    <div id="renderedKeyboard">
      Plug your MIDI instrument (if any), this click on the button.
      <button id="run">Start</button>
    </div>

    <canvas id="osc1" width="2400" height="300" style="width: 1200px; height: 150px;"></canvas>

    <script src="keyboard-input.js"></script>
    <script src="webmidi-reader.js"></script>
    <script src="launchkey-state.js"></script> <!-- imports initLaunchkeyState -->
    <script src="render.js"></script>
    
    <script src="lib/riffwave.js"></script> <!-- imports RIFFWAVE -->
    <script src="lib/sfxr.js"></script> <!-- imports SoundEffect -->
    <script src="lib/scope.js"></script> <!-- imports Scope -->
    <script src="sound-generator.js"></script>
    <script src="synth.js"></script> <!-- imports initSynth -->
    <script src="oscilloscope.js"></script> <!-- imports initOscilloscope -->
    <script src="note-player.js"></script>

    <script>
      // just to activate WebAudio after a user gesture
      document.getElementById('run').onclick = function() {

        // 1. Setup outputs

        const audioContext = new (window.AudioContext || window.webkitAudioContext);
  
        const oscilloscope = initOscilloscope({
          Scope,
          audioContext,
          canvas: document.querySelector('#osc1')
        });
        const synth = initSynth({ audioContext }); // creates an audio context for one "channel"
        const soundGenerator = initSoundGenerator({ SoundEffect });
        const notePlayer = initNotePlayer({ synth, soundGenerator, oscilloscope });
        
        // 2. Setup inputs

        const keyboardState = initLaunchkeyState();

        function handleParsedMidiMessage(message) {
          var state = keyboardState.mutateFromParsedMidiMessage(message);
          document.getElementById('renderedKeyboard').innerHTML = renderHTML(state);
          if (message.note) {
            notePlayer.playParsedMidiMessage(message);
          }
        }

        listenToKeyboardMessages(function(parsedMidiMessage) {
          handleParsedMidiMessage(parsedMidiMessage);
        });

        listenToMidiMessages(function(midiMessage) {
          handleParsedMidiMessage(keyboardState.parseMidiMessage(midiMessage));
        });

        // 3. Render the keyboard UI

        handleParsedMidiMessage({});
      };
    </script>
  </body>
</html>
